@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@using DevcraftWMS.DemoMvc.Infrastructure
@model DevcraftWMS.DemoMvc.ViewModels.OutboundOrders.OutboundOrderListPageViewModel
@{
    ViewData["Title"] = "Outbound Orders";
    ViewData["Subtitle"] = "Release and monitor outbound orders";

    var queryOptions = new GridQueryOptions
    {
        Action = "Index",
        Controller = "OutboundOrders",
        OrderBy = Model.Query.OrderBy,
        OrderDir = Model.Query.OrderDir,
        PageSize = Model.Query.PageSize,
        Query = new Dictionary<string, string?>
        {
            ["WarehouseId"] = Model.Query.WarehouseId?.ToString(),
            ["OrderNumber"] = Model.Query.OrderNumber,
            ["Status"] = Model.Query.Status?.ToString(),
            ["Priority"] = Model.Query.Priority?.ToString(),
            ["IsActive"] = Model.Query.IsActive?.ToString(),
            ["IncludeInactive"] = Model.Query.IncludeInactive.ToString(),
            ["PageSize"] = Model.Query.PageSize.ToString()
        }
    };

    var statusOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.Status is null },
        new() { Value = "0", Text = "Registered", Selected = Model.Query.Status == 0 },
        new() { Value = "1", Text = "Pending adjustment", Selected = Model.Query.Status == 1 },
        new() { Value = "2", Text = "Released", Selected = Model.Query.Status == 2 },
        new() { Value = "3", Text = "Picking", Selected = Model.Query.Status == 3 },
        new() { Value = "4", Text = "Checked", Selected = Model.Query.Status == 4 },
        new() { Value = "5", Text = "Packed", Selected = Model.Query.Status == 5 },
        new() { Value = "6", Text = "Shipping", Selected = Model.Query.Status == 6 },
        new() { Value = "7", Text = "Shipped", Selected = Model.Query.Status == 7 },
        new() { Value = "8", Text = "Partially shipped", Selected = Model.Query.Status == 8 },
        new() { Value = "9", Text = "Canceled", Selected = Model.Query.Status == 9 }
    };

    var priorityOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.Priority is null },
        new() { Value = "0", Text = "Low", Selected = Model.Query.Priority == 0 },
        new() { Value = "1", Text = "Normal", Selected = Model.Query.Priority == 1 },
        new() { Value = "2", Text = "High", Selected = Model.Query.Priority == 2 },
        new() { Value = "3", Text = "Urgent", Selected = Model.Query.Priority == 3 }
    };

    var statusFilter = new GridFilterField
    {
        Label = "Status",
        Name = "Status",
        Type = GridFilterType.Select,
        Options = statusOptions
    };

    var priorityFilter = new GridFilterField
    {
        Label = "Priority",
        Name = "Priority",
        Type = GridFilterType.Select,
        Options = priorityOptions
    };

    var warehouseOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.WarehouseId is null }
    };
    warehouseOptions.AddRange(Model.Warehouses.Select(wh => new GridSelectOption
    {
        Value = wh.Value,
        Text = wh.Text,
        Selected = wh.Selected
    }));

    var filters = new GridFilterViewModel
    {
        Action = "Index",
        Controller = "OutboundOrders",
        Fields = new List<GridFilterField>
        {
            new() { Name = "OrderBy", Value = Model.Query.OrderBy, IsHidden = true },
            new() { Name = "OrderDir", Value = Model.Query.OrderDir, IsHidden = true },
            new()
            {
                Label = "Warehouse",
                Name = "WarehouseId",
                Type = GridFilterType.Select,
                Options = warehouseOptions
            },
            new() { Label = "Order Number", Name = "OrderNumber", Value = Model.Query.OrderNumber },
            statusFilter,
            priorityFilter,
            new()
            {
                Label = "Active",
                Name = "IsActive",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = string.Empty, Text = "Any", Selected = Model.Query.IsActive is null },
                    new() { Value = "true", Text = "Active", Selected = Model.Query.IsActive == true },
                    new() { Value = "false", Text = "Inactive", Selected = Model.Query.IsActive == false }
                }
            },
            new()
            {
                Label = "Include inactive",
                Name = "IncludeInactive",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "false", Text = "No", Selected = Model.Query.IncludeInactive == false },
                    new() { Value = "true", Text = "Yes", Selected = Model.Query.IncludeInactive }
                }
            },
            new()
            {
                Label = "Page Size",
                Name = "PageSize",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "10", Text = "10", Selected = Model.Query.PageSize == 10 },
                    new() { Value = "25", Text = "25", Selected = Model.Query.PageSize == 25 },
                    new() { Value = "50", Text = "50", Selected = Model.Query.PageSize == 50 }
                }
            }
        },
        ShowReset = true,
        ResetUrl = Url.Action("Index", "OutboundOrders")
    };

    var filterDrawer = new FilterDrawerViewModel
    {
        Id = "outboundOrderFilters",
        Title = "Outbound order filters",
        Filters = filters,
        ButtonText = "Filters",
        ButtonCssClass = "btn btn-outline-primary"
    };

    string StatusLabel(int status) => status switch
    {
        0 => "Registered",
        1 => "Pending",
        2 => "Released",
        3 => "Picking",
        4 => "Checked",
        5 => "Packed",
        6 => "Shipping",
        7 => "Shipped",
        8 => "Partial",
        9 => "Canceled",
        _ => $"Status {status}"
    };

    string PriorityLabel(int priority) => priority switch
    {
        0 => "Low",
        1 => "Normal",
        2 => "High",
        3 => "Urgent",
        _ => $"Priority {priority}"
    };

    var grid = new GridBuilder<OutboundOrderListItemViewModel>()
        .WithTitle("Outbound Orders")
        .WithSubtitle($"Total: {Model.Pagination.TotalCount}")
        .WithItems(Model.Items)
        .WithPagination(Model.Pagination)
        .WithQueryOptions(queryOptions)
        .WithFilters(filters)
        .AddColumn("Order", item => new HtmlString(HtmlEncoder.Default.Encode(item.OrderNumber)), "OrderNumber")
        .AddColumn("Warehouse", item => new HtmlString(HtmlEncoder.Default.Encode(item.WarehouseName)), "WarehouseName")
        .AddColumn("Status", item => new HtmlString($"<span class=\"badge text-bg-primary\">{HtmlEncoder.Default.Encode(StatusLabel(item.Status))}</span>"), "Status")
        .AddColumn("Priority", item => new HtmlString($"<span class=\"badge text-bg-info\">{HtmlEncoder.Default.Encode(PriorityLabel(item.Priority))}</span>"), "Priority")
        .AddColumn("Expected Ship", item => new HtmlString(item.ExpectedShipDate?.ToString("yyyy-MM-dd") ?? "-"), "ExpectedShipDate")
        .AddColumn("Created", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")), "CreatedAtUtc")
        .AddAction("Details", item => Url.Action("Details", "OutboundOrders", new { id = item.Id }))
        .AddAction("Release", item => Url.Action("Details", "OutboundOrders", new { id = item.Id }), "btn btn-sm btn-outline-success")
        .Build();
}

<div class="d-flex justify-content-end gap-2 mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#outboundOrdersHelp">
        <i class="bi bi-question-circle me-1"></i>Help
    </button>
</div>
<partial name="_FilterDrawer" model="filterDrawer" />
<partial name="_Grid" model="grid" />
<partial name="_OutboundOrdersHelp" />

