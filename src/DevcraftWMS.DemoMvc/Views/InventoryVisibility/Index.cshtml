@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Mvc.Rendering
@using DevcraftWMS.DemoMvc.Enums
@model DevcraftWMS.DemoMvc.ViewModels.InventoryVisibility.InventoryVisibilityPageViewModel
@{
    ViewData["Title"] = "Inventory Visibility";
    ViewData["Subtitle"] = "Locate and explain stock by customer and warehouse";

    var queryOptions = new GridQueryOptions
    {
        Action = "Index",
        Controller = "InventoryVisibility",
        OrderBy = Model.Query.OrderBy,
        OrderDir = Model.Query.OrderDir,
        PageSize = Model.Query.PageSize,
        Query = new Dictionary<string, string?>
        {
            ["WarehouseId"] = Model.Query.WarehouseId?.ToString(),
            ["ProductId"] = Model.Query.ProductId?.ToString(),
            ["Sku"] = Model.Query.Sku,
            ["LotCode"] = Model.Query.LotCode,
            ["ExpirationFrom"] = Model.Query.ExpirationFrom?.ToString("yyyy-MM-dd"),
            ["ExpirationTo"] = Model.Query.ExpirationTo?.ToString("yyyy-MM-dd"),
            ["Status"] = Model.Query.Status?.ToString(),
            ["IsActive"] = Model.Query.IsActive?.ToString(),
            ["IncludeInactive"] = Model.Query.IncludeInactive.ToString(),
            ["PageSize"] = Model.Query.PageSize.ToString()
        }
    };

    List<GridSelectOption> SelectFromItems(IReadOnlyList<SelectListItem> items)
        => items.Select(item => new GridSelectOption
        {
            Value = item.Value ?? string.Empty,
            Text = item.Text ?? string.Empty,
            Selected = item.Selected
        }).ToList();

    var statusOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.Status is null }
    };
    statusOptions.AddRange(Enum.GetValues<InventoryBalanceStatus>()
        .Select(status => new GridSelectOption
        {
            Value = status.ToString(),
            Text = status.ToString(),
            Selected = Model.Query.Status == status
        }));

    var activeOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.IsActive is null },
        new() { Value = "true", Text = "Active", Selected = Model.Query.IsActive == true },
        new() { Value = "false", Text = "Inactive", Selected = Model.Query.IsActive == false }
    };

    var orderOptions = new List<GridSelectOption>
    {
        new() { Value = "ProductCode", Text = "Product code", Selected = Model.Query.OrderBy == "ProductCode" },
        new() { Value = "ProductName", Text = "Product name", Selected = Model.Query.OrderBy == "ProductName" },
        new() { Value = "QuantityOnHand", Text = "Quantity on hand", Selected = Model.Query.OrderBy == "QuantityOnHand" },
        new() { Value = "QuantityAvailable", Text = "Quantity available", Selected = Model.Query.OrderBy == "QuantityAvailable" },
        new() { Value = "QuantityBlocked", Text = "Quantity blocked", Selected = Model.Query.OrderBy == "QuantityBlocked" },
        new() { Value = "QuantityInProcess", Text = "Quantity in process", Selected = Model.Query.OrderBy == "QuantityInProcess" },
        new() { Value = "LocationCode", Text = "Location code", Selected = Model.Query.OrderBy == "LocationCode" },
        new() { Value = "LotCode", Text = "Lot code", Selected = Model.Query.OrderBy == "LotCode" },
        new() { Value = "ExpirationDate", Text = "Expiration date", Selected = Model.Query.OrderBy == "ExpirationDate" },
        new() { Value = "CreatedAtUtc", Text = "Created at", Selected = Model.Query.OrderBy == "CreatedAtUtc" }
    };

    var filters = new GridFilterViewModel
    {
        Action = "Index",
        Controller = "InventoryVisibility",
        Fields = new List<GridFilterField>
        {
            new() { Name = "OrderDir", Value = Model.Query.OrderDir, IsHidden = true },
            new() { Label = "Warehouse", Name = "WarehouseId", Type = GridFilterType.Select, Options = SelectFromItems(Model.Warehouses) },
            new() { Label = "Product", Name = "ProductId", Type = GridFilterType.Select, Options = SelectFromItems(Model.Products) },
            new() { Label = "SKU", Name = "Sku", Type = GridFilterType.Text, Value = Model.Query.Sku, Placeholder = "SKU code" },
            new() { Label = "Lot", Name = "LotCode", Type = GridFilterType.Text, Value = Model.Query.LotCode, Placeholder = "Lot code" },
            new() { Label = "Expiration from", Name = "ExpirationFrom", Type = GridFilterType.Date, Value = Model.Query.ExpirationFrom?.ToString("yyyy-MM-dd") },
            new() { Label = "Expiration to", Name = "ExpirationTo", Type = GridFilterType.Date, Value = Model.Query.ExpirationTo?.ToString("yyyy-MM-dd") },
            new() { Label = "Status", Name = "Status", Type = GridFilterType.Select, Options = statusOptions },
            new() { Label = "Active", Name = "IsActive", Type = GridFilterType.Select, Options = activeOptions },
            new() { Label = "Order by", Name = "OrderBy", Type = GridFilterType.Select, Options = orderOptions },
            new()
            {
                Label = "Include inactive",
                Name = "IncludeInactive",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "false", Text = "No", Selected = Model.Query.IncludeInactive == false },
                    new() { Value = "true", Text = "Yes", Selected = Model.Query.IncludeInactive }
                }
            },
            new()
            {
                Label = "Page Size",
                Name = "PageSize",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "10", Text = "10", Selected = Model.Query.PageSize == 10 },
                    new() { Value = "25", Text = "25", Selected = Model.Query.PageSize == 25 },
                    new() { Value = "50", Text = "50", Selected = Model.Query.PageSize == 50 }
                }
            }
        },
        ShowReset = true,
        ResetUrl = Url.Action("Index", "InventoryVisibility")
    };

    var filterDrawer = new FilterDrawerViewModel
    {
        Id = "inventoryVisibilityFilters",
        Title = "Inventory visibility filters",
        Filters = filters,
        ButtonText = "Filters",
        ButtonCssClass = "btn btn-outline-primary"
    };

    string StatusBadgeClass(InventoryBalanceStatus status)
        => status == InventoryBalanceStatus.Available ? "text-bg-success" : "text-bg-warning";

    string AlertBadgeClass(string severity)
        => severity?.ToLowerInvariant() switch
        {
            "critical" => "text-bg-danger",
            "warning" => "text-bg-warning",
            "info" => "text-bg-info",
            _ => "text-bg-secondary"
        };

    IHtmlContent RenderAlerts(IReadOnlyList<DevcraftWMS.DemoMvc.ViewModels.InventoryVisibility.InventoryVisibilityAlertViewModel> alerts)
    {
        if (alerts.Count == 0)
        {
            return new HtmlString("-");
        }

        var badges = string.Join(" ", alerts.Select(alert =>
            $"<span class=\"badge {AlertBadgeClass(alert.Severity)}\">{HtmlEncoder.Default.Encode(alert.Message)}</span>"));
        return new HtmlString(badges);
    }

    var summaryGrid = new GridBuilder<DevcraftWMS.DemoMvc.ViewModels.InventoryVisibility.InventoryVisibilitySummaryViewModel>()
        .WithTitle("Summary by product")
        .WithSubtitle($"Total: {Model.SummaryItems.Count}")
        .WithItems(Model.SummaryItems)
        .WithQueryOptions(queryOptions)
        .WithFilters(filters)
        .AddColumn("Product", item => new HtmlString(HtmlEncoder.Default.Encode($"{item.ProductCode} - {item.ProductName}")), "ProductCode")
        .AddColumn("UoM", item => new HtmlString(HtmlEncoder.Default.Encode(item.UomCode ?? "-")))
        .AddColumn("On hand", item => new HtmlString(item.QuantityOnHand.ToString("N2")), "QuantityOnHand")
        .AddColumn("Reserved", item => new HtmlString(item.QuantityReserved.ToString("N2")))
        .AddColumn("Blocked", item => new HtmlString(item.QuantityBlocked.ToString("N2")))
        .AddColumn("In process", item => new HtmlString(item.QuantityInProcess.ToString("N2")))
        .AddColumn("Available", item => new HtmlString($"<strong>{item.QuantityAvailable:N2}</strong>"), "QuantityAvailable")
        .AddColumn("Alerts", item => RenderAlerts(item.Alerts))
        .Build();

    var locationGrid = new GridBuilder<DevcraftWMS.DemoMvc.ViewModels.InventoryVisibility.InventoryVisibilityLocationViewModel>()
        .WithTitle("Physical distribution")
        .WithSubtitle($"Total: {Model.Pagination.TotalCount}")
        .WithItems(Model.LocationItems)
        .WithPagination(Model.Pagination)
        .WithQueryOptions(queryOptions)
        .WithFilters(filters)
        .AddColumn("Location", item => new HtmlString(HtmlEncoder.Default.Encode(item.LocationCode)), "LocationCode")
        .AddColumn("Structure", item => new HtmlString(HtmlEncoder.Default.Encode(item.StructureCode ?? "-")))
        .AddColumn("Section", item => new HtmlString(HtmlEncoder.Default.Encode(item.SectionCode ?? "-")))
        .AddColumn("Sector", item => new HtmlString(HtmlEncoder.Default.Encode(item.SectorCode ?? "-")))
        .AddColumn("Product", item => new HtmlString(HtmlEncoder.Default.Encode($"{item.ProductCode} - {item.ProductName}")), "ProductCode")
        .AddColumn("Lot", item => new HtmlString(HtmlEncoder.Default.Encode(item.LotCode ?? "-")), "LotCode")
        .AddColumn("Exp.", item => new HtmlString(item.ExpirationDate?.ToString("yyyy-MM-dd") ?? "-"), "ExpirationDate")
        .AddColumn("On hand", item => new HtmlString(item.QuantityOnHand.ToString("N2")), "QuantityOnHand")
        .AddColumn("Reserved", item => new HtmlString(item.QuantityReserved.ToString("N2")))
        .AddColumn("Blocked", item => new HtmlString(item.QuantityBlocked.ToString("N2")), "QuantityBlocked")
        .AddColumn("In process", item => new HtmlString(item.QuantityInProcess.ToString("N2")), "QuantityInProcess")
        .AddColumn("Available", item => new HtmlString($"<strong>{item.QuantityAvailable:N2}</strong>"), "QuantityAvailable")
        .AddColumn("Status", item => new HtmlString($"<span class=\"badge {StatusBadgeClass(item.Status)}\">{item.Status}</span>"), "Status")
        .AddColumn("Blocked reasons", item =>
        {
            if (item.BlockedReasons.Count == 0)
            {
                return new HtmlString("-");
            }

            var badges = string.Join(" ", item.BlockedReasons.Select(reason =>
                $"<span class=\"badge text-bg-warning\">{HtmlEncoder.Default.Encode(reason)}</span>"));
            return new HtmlString(badges);
        })
        .AddColumn("Alerts", item => RenderAlerts(item.Alerts))
        .AddColumn("Active", item => new HtmlString(item.IsActive ? "<span class=\"badge text-bg-success\">Active</span>" : "<span class=\"badge text-bg-secondary\">Inactive</span>"), "IsActive")
        .AddColumn("Created", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")), "CreatedAtUtc")
        .Build();

    var summaryText = string.Join(Environment.NewLine, Model.SummaryItems.Select(item =>
        $"{item.ProductCode} - {item.ProductName} | OnHand: {item.QuantityOnHand:N2} | Reserved: {item.QuantityReserved:N2} | Blocked: {item.QuantityBlocked:N2} | InProcess: {item.QuantityInProcess:N2} | Available: {item.QuantityAvailable:N2}"));

    var exportRouteValues = new
    {
        Model.Query.CustomerId,
        Model.Query.WarehouseId,
        Model.Query.ProductId,
        Model.Query.Sku,
        Model.Query.LotCode,
        ExpirationFrom = Model.Query.ExpirationFrom?.ToString("yyyy-MM-dd"),
        ExpirationTo = Model.Query.ExpirationTo?.ToString("yyyy-MM-dd"),
        Status = Model.Query.Status?.ToString(),
        IsActive = Model.Query.IsActive?.ToString(),
        IncludeInactive = Model.Query.IncludeInactive.ToString(),
        OrderBy = Model.Query.OrderBy,
        OrderDir = Model.Query.OrderDir
    };
}

@if (!Model.HasCustomerContext)
{
    <div class="alert alert-warning">
        Select a customer context to load the inventory visibility data.
    </div>
}

<div class="d-flex justify-content-end gap-2 mb-3">
    <a class="btn btn-outline-primary" href="@Url.Action("Export", "InventoryVisibility", exportRouteValues)?format=pdf">
        <i class="bi bi-file-earmark-pdf me-1"></i>PDF
    </a>
    <a class="btn btn-outline-success" href="@Url.Action("Export", "InventoryVisibility", exportRouteValues)?format=xlsx">
        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Excel
    </a>
    <a class="btn btn-outline-secondary" href="@Url.Action("Export", "InventoryVisibility", exportRouteValues)?format=print" target="_blank">
        <i class="bi bi-printer me-1"></i>Print
    </a>
    <button class="btn btn-outline-dark" type="button" id="copySummaryButton" data-copy-target="inventorySummaryCopy">
        <i class="bi bi-clipboard me-1"></i>Copy summary
    </button>
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#inventoryVisibilityHelp">
        <i class="bi bi-question-circle me-1"></i>Help
    </button>
</div>

<textarea id="inventorySummaryCopy" class="visually-hidden">@summaryText</textarea>

<partial name="_FilterDrawer" model="filterDrawer" />

<ul class="nav nav-pills mb-3" id="inventoryVisibilityTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="pill" data-bs-target="#summary" type="button" role="tab">
            Summary
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="locations-tab" data-bs-toggle="pill" data-bs-target="#locations" type="button" role="tab">
            Locations
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="timeline-tab" data-bs-toggle="pill" data-bs-target="#timeline" type="button" role="tab">
            Timeline
        </button>
    </li>
</ul>

<div class="tab-content" id="inventoryVisibilityTabsContent">
    <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <partial name="_Grid" model="summaryGrid" />
    </div>
    <div class="tab-pane fade" id="locations" role="tabpanel" aria-labelledby="locations-tab">
        <partial name="_Grid" model="locationGrid" />
    </div>
    <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
        <form method="get" class="mb-3">
            <input type="hidden" name="WarehouseId" value="@Model.Query.WarehouseId" />
            <input type="hidden" name="Sku" value="@Model.Query.Sku" />
            <input type="hidden" name="LotCode" value="@Model.Query.LotCode" />
            <input type="hidden" name="ExpirationFrom" value="@Model.Query.ExpirationFrom?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="ExpirationTo" value="@Model.Query.ExpirationTo?.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="Status" value="@Model.Query.Status?.ToString()" />
            <input type="hidden" name="IsActive" value="@Model.Query.IsActive?.ToString()" />
            <input type="hidden" name="IncludeInactive" value="@Model.Query.IncludeInactive.ToString()" />
            <input type="hidden" name="OrderBy" value="@Model.Query.OrderBy" />
            <input type="hidden" name="OrderDir" value="@Model.Query.OrderDir" />
            <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

            <div class="d-flex flex-wrap gap-2 align-items-end">
                <div>
                    <label class="form-label mb-1">Product</label>
                    <select class="form-select" name="ProductId">
                        <option value="">Select a product</option>
                        @foreach (var product in Model.Products)
                        {
                            <option value="@product.Value" selected="@(product.Selected ? "selected" : null)">@product.Text</option>
                        }
                    </select>
                </div>
                <div>
                    <button class="btn btn-primary" type="submit">Load timeline</button>
                </div>
                <div>
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#inventoryVisibilityFilters">
                        Open filters
                    </button>
                </div>
            </div>
        </form>

        @if (!Model.Query.ProductId.HasValue)
        {
            <div class="alert alert-info">
                Select a product to view the timeline.
            </div>
        }
        else if (Model.TraceItems.Count == 0)
        {
            <div class="alert alert-warning">
                No timeline events found for the selected product.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>When</th>
                            <th>Type</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.TraceItems)
                        {
                            <tr>
                                <td>@item.OccurredAtUtc.ToLocalTime().ToString("g")</td>
                                <td><span class="badge text-bg-secondary">@item.EventType</span></td>
                                <td>@item.Description</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="inventoryVisibilityHelp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inventory visibility tips</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="mb-0">
                    <li>Use the filters to narrow by warehouse, SKU, lot, and expiration window.</li>
                    <li>The summary tab aggregates quantities by product; locations show the physical spread.</li>
                    <li>Availability is computed as on-hand minus reserved and blocked quantities.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById("copySummaryButton")?.addEventListener("click", async () => {
        const target = document.getElementById("inventorySummaryCopy");
        if (!target) {
            return;
        }

        const text = target.value || target.textContent || "";
        try {
            await navigator.clipboard.writeText(text);
            alert("Summary copied to clipboard.");
        } catch {
            target.select();
            document.execCommand("copy");
            alert("Summary copied to clipboard.");
        }
    });
</script>
