@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    ViewData["Subtitle"] = "Visao geral da saude da API e atividade recente";

    var statusCard = new StatCardViewModel
    {
        Title = "Status da API",
        Value = Model.ApiHealthy ? "Saudavel" : "Indisponivel",
        BadgeText = Model.ApiHealthy ? "Online" : "Offline",
        BadgeCssClass = Model.ApiHealthy ? "text-bg-success" : "text-bg-danger",
        ActionText = "Configuracoes",
        ActionUrl = Url.Action("Index", "Settings"),
        IconClass = "bi bi-shield-check",
        IconCssClass = Model.ApiHealthy ? "text-bg-success-subtle text-success" : "text-bg-danger-subtle text-danger"
    };

    var warehousesCard = new StatCardViewModel
    {
        Title = "Armazens ativos",
        Value = Model.ActiveWarehouses.ToString("N0"),
        Subtitle = "Locais operacionais",
        BadgeText = Model.ActiveWarehouses > 0 ? "Ativos" : "Nenhum",
        BadgeCssClass = Model.ActiveWarehouses > 0 ? "text-bg-primary" : "text-bg-secondary",
        ActionText = "Gerenciar",
        ActionUrl = Url.Action("Index", "Warehouses"),
        IconClass = "bi bi-box-seam",
        IconCssClass = "text-bg-light border"
    };

    var expiringLotsCount = Model.ExpiringLots?.TotalLots ?? 0;
    var expiringDays = Model.ExpiringLots?.WindowDays ?? 90;
    var expiringTo = DateTime.UtcNow.Date.AddDays(expiringDays).ToString("yyyy-MM-dd");
    var expiringFrom = DateTime.UtcNow.Date.ToString("yyyy-MM-dd");
    var expiringLotsCard = new StatCardViewModel
    {
        Title = "Lotes a vencer",
        Value = expiringLotsCount.ToString("N0"),
        Subtitle = $"Proximos {expiringDays} dias",
        BadgeText = expiringLotsCount > 0 ? "Atencao" : "Estavel",
        BadgeCssClass = expiringLotsCount > 0 ? "text-bg-warning" : "text-bg-success",
        ActionText = "Ver lotes",
        ActionUrl = Url.Action("Index", "Lots", new { ExpirationFrom = expiringFrom, ExpirationTo = expiringTo }),
        IconClass = "bi bi-calendar2-week",
        IconCssClass = expiringLotsCount > 0 ? "text-bg-warning-subtle text-warning" : "text-bg-success-subtle text-success"
    };

    var inboundWindowDays = Model.InboundWindowDays > 0 ? Model.InboundWindowDays : 30;
    var inboundKpis = Model.InboundKpis;
    var inboundArrivals = inboundKpis?.Arrivals ?? 0;
    var inboundDockAssigned = inboundKpis?.DockAssigned ?? 0;
    var inboundReceiptsCompleted = inboundKpis?.ReceiptsCompleted ?? 0;
    var inboundPutawayCompleted = inboundKpis?.PutawayCompleted ?? 0;

    var outboundWindowDays = Model.OutboundWindowDays > 0 ? Model.OutboundWindowDays : 30;
    var outboundKpis = Model.OutboundKpis;
    var outboundPickingCompleted = outboundKpis?.PickingCompleted ?? 0;
    var outboundChecksCompleted = outboundKpis?.ChecksCompleted ?? 0;
    var outboundShipmentsCompleted = outboundKpis?.ShipmentsCompleted ?? 0;

    var inboundArrivalsCard = new StatCardViewModel
    {
        Title = "Chegadas na portaria",
        Value = inboundArrivals.ToString("N0"),
        Subtitle = $"Ultimos {inboundWindowDays} dias",
        BadgeText = inboundArrivals > 0 ? "Entrada" : "Nenhum",
        BadgeCssClass = inboundArrivals > 0 ? "text-bg-primary" : "text-bg-secondary",
        ActionText = "Portaria",
        ActionUrl = Url.Action("Index", "GateCheckins"),
        IconClass = "bi bi-door-open",
        IconCssClass = inboundArrivals > 0 ? "text-bg-primary-subtle text-primary" : "text-bg-light border"
    };

    var inboundDockAssignedCard = new StatCardViewModel
    {
        Title = "Doca atribuida",
        Value = inboundDockAssigned.ToString("N0"),
        Subtitle = $"Ultimos {inboundWindowDays} dias",
        BadgeText = inboundDockAssigned > 0 ? "Na doca" : "Nenhum",
        BadgeCssClass = inboundDockAssigned > 0 ? "text-bg-info" : "text-bg-secondary",
        ActionText = "Fila",
        ActionUrl = Url.Action("Queue", "GateCheckins"),
        IconClass = "bi bi-truck-front",
        IconCssClass = inboundDockAssigned > 0 ? "text-bg-info-subtle text-info" : "text-bg-light border"
    };

    var inboundReceiptsCard = new StatCardViewModel
    {
        Title = "Recebimentos concluidos",
        Value = inboundReceiptsCompleted.ToString("N0"),
        Subtitle = $"Ultimos {inboundWindowDays} dias",
        BadgeText = inboundReceiptsCompleted > 0 ? "Concluidos" : "Nenhum",
        BadgeCssClass = inboundReceiptsCompleted > 0 ? "text-bg-success" : "text-bg-secondary",
        ActionText = "Recebimentos",
        ActionUrl = Url.Action("Index", "Receipts"),
        IconClass = "bi bi-receipt",
        IconCssClass = inboundReceiptsCompleted > 0 ? "text-bg-success-subtle text-success" : "text-bg-light border"
    };

    var inboundPutawayCard = new StatCardViewModel
    {
        Title = "Enderecamentos concluidos",
        Value = inboundPutawayCompleted.ToString("N0"),
        Subtitle = $"Ultimos {inboundWindowDays} dias",
        BadgeText = inboundPutawayCompleted > 0 ? "Armazenado" : "Nenhum",
        BadgeCssClass = inboundPutawayCompleted > 0 ? "text-bg-warning" : "text-bg-secondary",
        ActionText = "Enderecamento",
        ActionUrl = Url.Action("Index", "PutawayTasks"),
        IconClass = "bi bi-box-arrow-in-down",
        IconCssClass = inboundPutawayCompleted > 0 ? "text-bg-warning-subtle text-warning" : "text-bg-light border"
    };

    var outboundPickingCard = new StatCardViewModel
    {
        Title = "Separacoes concluidas",
        Value = outboundPickingCompleted.ToString("N0"),
        Subtitle = $"Ultimos {outboundWindowDays} dias",
        BadgeText = outboundPickingCompleted > 0 ? "Concluido" : "Nenhum",
        BadgeCssClass = outboundPickingCompleted > 0 ? "text-bg-primary" : "text-bg-secondary",
        ActionText = "Separacao",
        ActionUrl = Url.Action("Index", "PickingTasks"),
        IconClass = "bi bi-hand-index-thumb",
        IconCssClass = outboundPickingCompleted > 0 ? "text-bg-primary-subtle text-primary" : "text-bg-light border"
    };

    var outboundChecksCard = new StatCardViewModel
    {
        Title = "Conferencias concluidas",
        Value = outboundChecksCompleted.ToString("N0"),
        Subtitle = $"Ultimos {outboundWindowDays} dias",
        BadgeText = outboundChecksCompleted > 0 ? "Conferido" : "Nenhum",
        BadgeCssClass = outboundChecksCompleted > 0 ? "text-bg-info" : "text-bg-secondary",
        ActionText = "Conferencias",
        ActionUrl = Url.Action("Index", "OutboundChecks"),
        IconClass = "bi bi-clipboard-check",
        IconCssClass = outboundChecksCompleted > 0 ? "text-bg-info-subtle text-info" : "text-bg-light border"
    };

    var outboundShipmentsCard = new StatCardViewModel
    {
        Title = "Expedicoes concluidas",
        Value = outboundShipmentsCompleted.ToString("N0"),
        Subtitle = $"Ultimos {outboundWindowDays} dias",
        BadgeText = outboundShipmentsCompleted > 0 ? "Expedido" : "Nenhum",
        BadgeCssClass = outboundShipmentsCompleted > 0 ? "text-bg-success" : "text-bg-secondary",
        ActionText = "Expedicao",
        ActionUrl = Url.Action("Index", "OutboundShipping"),
        IconClass = "bi bi-truck-flatbed",
        IconCssClass = outboundShipmentsCompleted > 0 ? "text-bg-success-subtle text-success" : "text-bg-light border"
    };

    var quickLinks = new QuickLinksViewModel
    {
        Title = "Atalhos",
        Links = new List<QuickLinkItem>
        {
            new() { Text = "Clientes", Url = Url.Action("Index", "Customers") ?? "#", IconClass = "bi bi-people" },
            new() { Text = "Produtos", Url = Url.Action("Index", "Products") ?? "#", IconClass = "bi bi-upc" },
            new() { Text = "Lotes", Url = Url.Action("Index", "Lots") ?? "#", IconClass = "bi bi-collection" },
            new() { Text = "Recebimentos", Url = Url.Action("Index", "Receipts") ?? "#", IconClass = "bi bi-receipt" },
            new() { Text = "Unidades de medida", Url = Url.Action("Index", "Uoms") ?? "#", IconClass = "bi bi-rulers" },
            new() { Text = "Armazens", Url = Url.Action("Index", "Warehouses") ?? "#", IconClass = "bi bi-box-seam" },
            new() { Text = "Setores", Url = Url.Action("Index", "Sectors") ?? "#", IconClass = "bi bi-grid-3x3-gap" },
            new() { Text = "Secoes", Url = Url.Action("Index", "Sections") ?? "#", IconClass = "bi bi-layout-text-sidebar" },
            new() { Text = "Corredores", Url = Url.Action("Index", "Aisles") ?? "#", IconClass = "bi bi-arrow-up-down" },
            new() { Text = "Estruturas", Url = Url.Action("Index", "Structures") ?? "#", IconClass = "bi bi-stack" },
            new() { Text = "Enderecos", Url = Url.Action("Index", "Locations") ?? "#", IconClass = "bi bi-geo-alt" },
            new() { Text = "Teste de email", Url = Url.Action("Index", "Email") ?? "#", IconClass = "bi bi-envelope" },
            new() { Text = "Logs", Url = Url.Action("Requests", "Logs") ?? "#", IconClass = "bi bi-activity" }
        }
    };

    var requestPageSize = Math.Max(Model.RecentRequests.Count, 1);
    var requestPagination = new PaginationViewModel
    {
        PageNumber = 1,
        PageSize = requestPageSize,
        TotalCount = Model.RecentRequests.Count,
        Action = "Requests",
        Controller = "Logs"
    };

    var requestQueryOptions = new GridQueryOptions
    {
        Action = "Requests",
        Controller = "Logs",
        PageSize = requestPageSize
    };

    var requestGrid = new GridBuilder<RequestLogDto>()
        .WithTitle("Requisicoes recentes")
        .WithSubtitle(Model.RecentRequests.Count == 0 ? "Ainda nao ha requisicoes." : $"Total: {Model.RecentRequests.Count}")
        .WithItems(Model.RecentRequests)
        .WithPagination(requestPagination)
        .WithQueryOptions(requestQueryOptions)
        .WithEmptyMessage("Ainda nao ha requisicoes.")
        .WithTableCssClass("table table-sm align-middle mb-0 grid-table")
        .AddColumn("Hora", item => new HtmlString(item.StartedAtUtc.ToLocalTime().ToString("g")))
        .AddColumn("Metodo", item => new HtmlString(HtmlEncoder.Default.Encode(item.Method)))
        .AddColumn("Caminho", item => new HtmlString(HtmlEncoder.Default.Encode(item.Path)))
        .AddColumn("Status", item => new HtmlString($"<span class=\"badge text-bg-light border\">{item.StatusCode}</span>"))
        .Build();

    var errorPageSize = Math.Max(Model.RecentErrors.Count, 1);
    var errorPagination = new PaginationViewModel
    {
        PageNumber = 1,
        PageSize = errorPageSize,
        TotalCount = Model.RecentErrors.Count,
        Action = "Errors",
        Controller = "Logs"
    };

    var errorQueryOptions = new GridQueryOptions
    {
        Action = "Errors",
        Controller = "Logs",
        PageSize = errorPageSize
    };

    var errorGrid = new GridBuilder<ErrorLogDto>()
        .WithTitle("Erros recentes")
        .WithSubtitle(Model.RecentErrors.Count == 0 ? "Ainda nao ha erros." : $"Total: {Model.RecentErrors.Count}")
        .WithItems(Model.RecentErrors)
        .WithPagination(errorPagination)
        .WithQueryOptions(errorQueryOptions)
        .WithEmptyMessage("Ainda nao ha erros.")
        .WithTableCssClass("table table-sm align-middle mb-0 grid-table")
        .AddColumn("Hora", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")))
        .AddColumn("Tipo", item => new HtmlString(HtmlEncoder.Default.Encode(item.ExceptionType)))
        .AddColumn("Mensagem", item =>
        {
            var message = HtmlEncoder.Default.Encode(item.Message);
            return new HtmlString($"<span class=\"text-truncate d-inline-block\" style=\"max-width: 240px;\">{message}</span>");
        })
        .Build();
}

<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#dashboardHelp">
        <i class="bi bi-question-circle me-1"></i>Ajuda
    </button>
</div>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-2 gap-2">
    <div>
        <h5 class="mb-1">Sistema e estoque</h5>
        <div class="text-muted small">Saude, recursos essenciais e lotes a vencer.</div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="statusCard" />
    </div>
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="warehousesCard" />
    </div>
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="expiringLotsCard" />
    </div>
</div>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-2 gap-2">
    <div>
        <h5 class="mb-1">KPIs de entrada</h5>
        <div class="text-muted small">Acompanhe o desempenho do fluxo de entrada no periodo selecionado.</div>
    </div>
    <form method="get" class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
            <select class="form-select" name="inboundDays" aria-label="Dias do periodo de entrada">
                <option value="7" selected="@(inboundWindowDays == 7)">Ultimos 7 dias</option>
                <option value="14" selected="@(inboundWindowDays == 14)">Ultimos 14 dias</option>
                <option value="30" selected="@(inboundWindowDays == 30)">Ultimos 30 dias</option>
                <option value="90" selected="@(inboundWindowDays == 90)">Ultimos 90 dias</option>
            </select>
        </div>
        <button type="submit" class="btn btn-outline-primary btn-sm">Aplicar</button>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundArrivalsCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundDockAssignedCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundReceiptsCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundPutawayCard" />
    </div>
</div>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-2 gap-2">
    <div>
        <h5 class="mb-1">KPIs de saida</h5>
        <div class="text-muted small">Acompanhe o desempenho do fluxo de saida no periodo selecionado.</div>
    </div>
    <form method="get" class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
            <select class="form-select" name="outboundDays" aria-label="Dias do periodo de saida">
                <option value="7" selected="@(outboundWindowDays == 7)">Ultimos 7 dias</option>
                <option value="14" selected="@(outboundWindowDays == 14)">Ultimos 14 dias</option>
                <option value="30" selected="@(outboundWindowDays == 30)">Ultimos 30 dias</option>
                <option value="90" selected="@(outboundWindowDays == 90)">Ultimos 90 dias</option>
            </select>
        </div>
        <button type="submit" class="btn btn-outline-primary btn-sm">Aplicar</button>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="outboundPickingCard" />
    </div>
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="outboundChecksCard" />
    </div>
    <div class="col-lg-4 col-md-6">
        <partial name="_StatCard" model="outboundShipmentsCard" />
    </div>
</div>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-2 gap-2">
    <div>
        <h5 class="mb-1">Operacoes e atalhos</h5>
        <div class="text-muted small">Acesse telas principais e monitore a atividade recente da API.</div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-4">
        <partial name="_QuickLinks" model="quickLinks" />
    </div>
    <div class="col-lg-8">
        <partial name="_Grid" model="requestGrid" />
    </div>
</div>

<partial name="_DashboardHelp" />

<div class="row g-3">
    <div class="col-lg-8">
        <partial name="_Grid" model="errorGrid" />
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small">Vitrine de UI</div>
                <p class="mt-2">Explore componentes reutilizaveis para formularios, tabelas e estados vazios.</p>
                <a class="btn btn-primary btn-sm" asp-controller="Ui" asp-action="Showcase">Abrir vitrine de UI</a>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <div class="text-muted small">Teste de telemetria</div>
                <p class="mt-2">Forca uma excecao de UI para validar a captura de logs do frontend.</p>
                <form asp-controller="Home" asp-action="Throw" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        Forcar erro de UI
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
