@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    ViewData["Subtitle"] = "Overview of API health and recent activity";

    var statusCard = new StatCardViewModel
    {
        Title = "API Status",
        Value = Model.ApiHealthy ? "Healthy" : "Unavailable",
        BadgeText = Model.ApiHealthy ? "Up" : "Down",
        BadgeCssClass = Model.ApiHealthy ? "text-bg-success" : "text-bg-danger",
        ActionText = "Settings",
        ActionUrl = Url.Action("Index", "Settings"),
        IconClass = "bi bi-shield-check",
        IconCssClass = Model.ApiHealthy ? "text-bg-success-subtle text-success" : "text-bg-danger-subtle text-danger"
    };

    var warehousesCard = new StatCardViewModel
    {
        Title = "Active Warehouses",
        Value = Model.ActiveWarehouses.ToString("N0"),
        Subtitle = "Operational locations",
        BadgeText = Model.ActiveWarehouses > 0 ? "Active" : "None",
        BadgeCssClass = Model.ActiveWarehouses > 0 ? "text-bg-primary" : "text-bg-secondary",
        ActionText = "Manage",
        ActionUrl = Url.Action("Index", "Warehouses"),
        IconClass = "bi bi-box-seam",
        IconCssClass = "text-bg-light border"
    };

    var expiringLotsCount = Model.ExpiringLots?.TotalLots ?? 0;
    var expiringDays = Model.ExpiringLots?.WindowDays ?? 90;
    var expiringTo = DateTime.UtcNow.Date.AddDays(expiringDays).ToString("yyyy-MM-dd");
    var expiringFrom = DateTime.UtcNow.Date.ToString("yyyy-MM-dd");
    var expiringLotsCard = new StatCardViewModel
    {
        Title = "Expiring Lots",
        Value = expiringLotsCount.ToString("N0"),
        Subtitle = $"Next {expiringDays} days",
        BadgeText = expiringLotsCount > 0 ? "Attention" : "Stable",
        BadgeCssClass = expiringLotsCount > 0 ? "text-bg-warning" : "text-bg-success",
        ActionText = "View lots",
        ActionUrl = Url.Action("Index", "Lots", new { ExpirationFrom = expiringFrom, ExpirationTo = expiringTo }),
        IconClass = "bi bi-calendar2-week",
        IconCssClass = expiringLotsCount > 0 ? "text-bg-warning-subtle text-warning" : "text-bg-success-subtle text-success"
    };

    var inboundWindowDays = Model.InboundWindowDays > 0 ? Model.InboundWindowDays : 30;
    var inboundKpis = Model.InboundKpis;
    var inboundArrivals = inboundKpis?.Arrivals ?? 0;
    var inboundDockAssigned = inboundKpis?.DockAssigned ?? 0;
    var inboundReceiptsCompleted = inboundKpis?.ReceiptsCompleted ?? 0;
    var inboundPutawayCompleted = inboundKpis?.PutawayCompleted ?? 0;

    var inboundArrivalsCard = new StatCardViewModel
    {
        Title = "Gate Arrivals",
        Value = inboundArrivals.ToString("N0"),
        Subtitle = $"Last {inboundWindowDays} days",
        BadgeText = inboundArrivals > 0 ? "Inbound" : "None",
        BadgeCssClass = inboundArrivals > 0 ? "text-bg-primary" : "text-bg-secondary",
        ActionText = "Portaria",
        ActionUrl = Url.Action("Index", "GateCheckins"),
        IconClass = "bi bi-door-open",
        IconCssClass = inboundArrivals > 0 ? "text-bg-primary-subtle text-primary" : "text-bg-light border"
    };

    var inboundDockAssignedCard = new StatCardViewModel
    {
        Title = "Dock Assigned",
        Value = inboundDockAssigned.ToString("N0"),
        Subtitle = $"Last {inboundWindowDays} days",
        BadgeText = inboundDockAssigned > 0 ? "At Dock" : "None",
        BadgeCssClass = inboundDockAssigned > 0 ? "text-bg-info" : "text-bg-secondary",
        ActionText = "Queue",
        ActionUrl = Url.Action("Queue", "GateCheckins"),
        IconClass = "bi bi-truck-front",
        IconCssClass = inboundDockAssigned > 0 ? "text-bg-info-subtle text-info" : "text-bg-light border"
    };

    var inboundReceiptsCard = new StatCardViewModel
    {
        Title = "Receipts Completed",
        Value = inboundReceiptsCompleted.ToString("N0"),
        Subtitle = $"Last {inboundWindowDays} days",
        BadgeText = inboundReceiptsCompleted > 0 ? "Completed" : "None",
        BadgeCssClass = inboundReceiptsCompleted > 0 ? "text-bg-success" : "text-bg-secondary",
        ActionText = "Receipts",
        ActionUrl = Url.Action("Index", "Receipts"),
        IconClass = "bi bi-receipt",
        IconCssClass = inboundReceiptsCompleted > 0 ? "text-bg-success-subtle text-success" : "text-bg-light border"
    };

    var inboundPutawayCard = new StatCardViewModel
    {
        Title = "Putaway Completed",
        Value = inboundPutawayCompleted.ToString("N0"),
        Subtitle = $"Last {inboundWindowDays} days",
        BadgeText = inboundPutawayCompleted > 0 ? "Stored" : "None",
        BadgeCssClass = inboundPutawayCompleted > 0 ? "text-bg-warning" : "text-bg-secondary",
        ActionText = "Putaway",
        ActionUrl = Url.Action("Index", "PutawayTasks"),
        IconClass = "bi bi-box-arrow-in-down",
        IconCssClass = inboundPutawayCompleted > 0 ? "text-bg-warning-subtle text-warning" : "text-bg-light border"
    };

    var quickLinks = new QuickLinksViewModel
    {
        Title = "Quick Links",
        Links = new List<QuickLinkItem>
        {
            new() { Text = "Customers", Url = Url.Action("Index", "Customers") ?? "#", IconClass = "bi bi-people" },
            new() { Text = "Products", Url = Url.Action("Index", "Products") ?? "#", IconClass = "bi bi-upc" },
            new() { Text = "Lots", Url = Url.Action("Index", "Lots") ?? "#", IconClass = "bi bi-collection" },
            new() { Text = "Receipts", Url = Url.Action("Index", "Receipts") ?? "#", IconClass = "bi bi-receipt" },
            new() { Text = "UoM", Url = Url.Action("Index", "Uoms") ?? "#", IconClass = "bi bi-rulers" },
            new() { Text = "Warehouses", Url = Url.Action("Index", "Warehouses") ?? "#", IconClass = "bi bi-box-seam" },
            new() { Text = "Sectors", Url = Url.Action("Index", "Sectors") ?? "#", IconClass = "bi bi-grid-3x3-gap" },
            new() { Text = "Sections", Url = Url.Action("Index", "Sections") ?? "#", IconClass = "bi bi-layout-text-sidebar" },
            new() { Text = "Aisles", Url = Url.Action("Index", "Aisles") ?? "#", IconClass = "bi bi-arrow-up-down" },
            new() { Text = "Structures", Url = Url.Action("Index", "Structures") ?? "#", IconClass = "bi bi-stack" },
            new() { Text = "Locations", Url = Url.Action("Index", "Locations") ?? "#", IconClass = "bi bi-geo-alt" },
            new() { Text = "Email Test", Url = Url.Action("Index", "Email") ?? "#", IconClass = "bi bi-envelope" },
            new() { Text = "Logs", Url = Url.Action("Requests", "Logs") ?? "#", IconClass = "bi bi-activity" }
        }
    };

    var requestPageSize = Math.Max(Model.RecentRequests.Count, 1);
    var requestPagination = new PaginationViewModel
    {
        PageNumber = 1,
        PageSize = requestPageSize,
        TotalCount = Model.RecentRequests.Count,
        Action = "Requests",
        Controller = "Logs"
    };

    var requestQueryOptions = new GridQueryOptions
    {
        Action = "Requests",
        Controller = "Logs",
        PageSize = requestPageSize
    };

    var requestGrid = new GridBuilder<RequestLogDto>()
        .WithTitle("Recent Requests")
        .WithSubtitle(Model.RecentRequests.Count == 0 ? "No request logs yet." : $"Total: {Model.RecentRequests.Count}")
        .WithItems(Model.RecentRequests)
        .WithPagination(requestPagination)
        .WithQueryOptions(requestQueryOptions)
        .WithEmptyMessage("No request logs yet.")
        .WithTableCssClass("table table-sm align-middle mb-0 grid-table")
        .AddColumn("Time", item => new HtmlString(item.StartedAtUtc.ToLocalTime().ToString("g")))
        .AddColumn("Method", item => new HtmlString(HtmlEncoder.Default.Encode(item.Method)))
        .AddColumn("Path", item => new HtmlString(HtmlEncoder.Default.Encode(item.Path)))
        .AddColumn("Status", item => new HtmlString($"<span class=\"badge text-bg-light border\">{item.StatusCode}</span>"))
        .Build();

    var errorPageSize = Math.Max(Model.RecentErrors.Count, 1);
    var errorPagination = new PaginationViewModel
    {
        PageNumber = 1,
        PageSize = errorPageSize,
        TotalCount = Model.RecentErrors.Count,
        Action = "Errors",
        Controller = "Logs"
    };

    var errorQueryOptions = new GridQueryOptions
    {
        Action = "Errors",
        Controller = "Logs",
        PageSize = errorPageSize
    };

    var errorGrid = new GridBuilder<ErrorLogDto>()
        .WithTitle("Recent Errors")
        .WithSubtitle(Model.RecentErrors.Count == 0 ? "No errors logged." : $"Total: {Model.RecentErrors.Count}")
        .WithItems(Model.RecentErrors)
        .WithPagination(errorPagination)
        .WithQueryOptions(errorQueryOptions)
        .WithEmptyMessage("No errors logged.")
        .WithTableCssClass("table table-sm align-middle mb-0 grid-table")
        .AddColumn("Time", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")))
        .AddColumn("Type", item => new HtmlString(HtmlEncoder.Default.Encode(item.ExceptionType)))
        .AddColumn("Message", item =>
        {
            var message = HtmlEncoder.Default.Encode(item.Message);
            return new HtmlString($"<span class=\"text-truncate d-inline-block\" style=\"max-width: 240px;\">{message}</span>");
        })
        .Build();
}

<div class="d-flex justify-content-end mb-3">
    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#dashboardHelp">
        <i class="bi bi-question-circle me-1"></i>Help
    </button>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="statusCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="warehousesCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="expiringLotsCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_QuickLinks" model="quickLinks" />
    </div>
    <div class="col-lg-6">
        <partial name="_Grid" model="requestGrid" />
    </div>
</div>

<div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between mb-2 gap-2">
    <div>
        <h5 class="mb-1">Inbound KPIs</h5>
        <div class="text-muted small">Track inbound flow performance for the selected window.</div>
    </div>
    <form method="get" class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-calendar-range"></i></span>
            <select class="form-select" name="inboundDays" aria-label="Inbound window days">
                <option value="7" selected="@(inboundWindowDays == 7)">Last 7 days</option>
                <option value="14" selected="@(inboundWindowDays == 14)">Last 14 days</option>
                <option value="30" selected="@(inboundWindowDays == 30)">Last 30 days</option>
                <option value="90" selected="@(inboundWindowDays == 90)">Last 90 days</option>
            </select>
        </div>
        <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
    </form>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundArrivalsCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundDockAssignedCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundReceiptsCard" />
    </div>
    <div class="col-lg-3 col-md-6">
        <partial name="_StatCard" model="inboundPutawayCard" />
    </div>
</div>

<partial name="_DashboardHelp" />

<div class="row g-3">
    <div class="col-lg-8">
        <partial name="_Grid" model="errorGrid" />
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <div class="text-muted small">UI Showcase</div>
                <p class="mt-2">Explore reusable components for forms, tables, and empty states.</p>
                <a class="btn btn-primary btn-sm" asp-controller="Ui" asp-action="Showcase">Open UI Showcase</a>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <div class="text-muted small">Telemetry Test</div>
                <p class="mt-2">Force a UI exception to validate frontend log capture.</p>
                <form asp-controller="Home" asp-action="Throw" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                        Force UI Error
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
