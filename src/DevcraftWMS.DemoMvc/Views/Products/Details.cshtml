@using DevcraftWMS.DemoMvc.Infrastructure
@using DevcraftWMS.DemoMvc.ViewModels.Shared
@using Microsoft.AspNetCore.Html
@model DevcraftWMS.DemoMvc.ViewModels.Products.ProductDetailsPageViewModel
@{
    ViewData["Title"] = "Product Details";
    ViewData["Subtitle"] = $"{Model.Product.Code} - {Model.Product.Name}";

    var coreInfo = new InfoListViewModel
    {
        Title = "Core details",
        Items = new List<InfoListItem>
        {
            new() { Label = "SKU", Value = Model.Product.Code },
            new() { Label = "Name", Value = Model.Product.Name },
            new() { Label = "EAN", Value = string.IsNullOrWhiteSpace(Model.Product.Ean) ? "-" : Model.Product.Ean },
            new() { Label = "ERP Code", Value = string.IsNullOrWhiteSpace(Model.Product.ErpCode) ? "-" : Model.Product.ErpCode },
            new() { Label = "Category", Value = string.IsNullOrWhiteSpace(Model.Product.Category) ? "-" : Model.Product.Category },
            new() { Label = "Brand", Value = string.IsNullOrWhiteSpace(Model.Product.Brand) ? "-" : Model.Product.Brand },
            new() { Label = "Tracking", Value = Model.Product.TrackingMode.GetDisplayName() },
            new() { Label = "Minimum Shelf Life (days)", Value = Model.Product.MinimumShelfLifeDays?.ToString() ?? "-" },
            new() { Label = "Status", Value = Model.Product.IsActive ? "Active" : "Inactive", BadgeText = Model.Product.IsActive ? "Active" : "Inactive", BadgeCssClass = Model.Product.IsActive ? "text-bg-success" : "text-bg-secondary" },
            new() { Label = "Created", Value = Model.Product.CreatedAtUtc.ToLocalTime().ToString("g") }
        }
    };

    var dimensionInfo = new InfoListViewModel
    {
        Title = "Dimensions & Weight",
        Items = new List<InfoListItem>
        {
            new() { Label = "Weight (kg)", Value = Model.Product.WeightKg?.ToString("N4") ?? "-" },
            new() { Label = "Length (cm)", Value = Model.Product.LengthCm?.ToString("N4") ?? "-" },
            new() { Label = "Width (cm)", Value = Model.Product.WidthCm?.ToString("N4") ?? "-" },
            new() { Label = "Height (cm)", Value = Model.Product.HeightCm?.ToString("N4") ?? "-" },
            new() { Label = "Volume (cmÂ³)", Value = Model.Product.VolumeCm3?.ToString("N4") ?? "-" }
        }
    };

    var uomGrid = new GridBuilder<ProductUomListItemViewModel>()
        .WithTitle("UoM Conversions")
        .WithSubtitle(Model.Uoms.Count == 0 ? "No conversions yet." : $"Total: {Model.Uoms.Count}")
        .WithItems(Model.Uoms)
        .WithPagination(new PaginationViewModel { PageNumber = 1, PageSize = Math.Max(Model.Uoms.Count, 1), TotalCount = Model.Uoms.Count })
        .WithQueryOptions(new GridQueryOptions { Action = "Details", Controller = "Products" })
        .WithEmptyMessage("No conversions configured.")
        .WithTableCssClass("table table-sm align-middle mb-0 grid-table")
        .AddColumn("UoM", item => new HtmlString($"{item.UomCode} - {item.UomName}"))
        .AddColumn("Factor", item => new HtmlString(item.ConversionFactor.ToString("N4")))
        .AddColumn("Base", item => new HtmlString(item.IsBase ? "<span class=\"badge text-bg-primary\">Base</span>" : "-"))
        .Build();
}

<div class="card mb-3">
    <div class="card-body d-flex gap-2">
        <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Product.Id">Edit</a>
        <a class="btn btn-outline-danger" asp-action="Delete" asp-route-id="@Model.Product.Id">Deactivate</a>
        <a class="btn btn-outline-secondary" asp-controller="Lots" asp-action="Index" asp-route-productId="@Model.Product.Id">Lots</a>
        <a class="btn btn-light border" asp-action="Index">Back</a>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <partial name="_InfoList" model="coreInfo" />
    </div>
    <div class="col-lg-6">
        <partial name="_InfoList" model="dimensionInfo" />
    </div>
</div>

<div class="row g-3 mt-3">
    <div class="col-lg-8">
        <partial name="_Grid" model="uomGrid" />
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Add UoM Conversion</h6>
            </div>
            <div class="card-body">
                <form asp-action="AddUom" asp-route-id="@Model.Product.Id" method="post">
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label">UoM</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-rulers"></i></span>
                            <select class="form-select" asp-for="NewUom.UomId" asp-items="Model.AvailableUoms">
                                <option value="">Select</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conversion Factor</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-arrow-left-right"></i></span>
                            <input class="form-control" asp-for="NewUom.ConversionFactor" type="number" step="0.0001" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-outline-primary">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>
