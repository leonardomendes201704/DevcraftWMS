@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@using DevcraftWMS.DemoMvc.ViewModels.Shared
@model DevcraftWMS.DemoMvc.ViewModels.InboundOrders.InboundOrderListPageViewModel
@{
    ViewData["Title"] = "Inbound Orders";
    ViewData["Subtitle"] = "Backoffice queue for OE status and priority";

    var queryOptions = new GridQueryOptions
    {
        Action = "Index",
        Controller = "InboundOrders",
        OrderBy = Model.Query.OrderBy,
        OrderDir = Model.Query.OrderDir,
        PageSize = Model.Query.PageSize,
        Query = new Dictionary<string, string?>
        {
            ["WarehouseId"] = Model.Query.WarehouseId?.ToString(),
            ["OrderNumber"] = Model.Query.OrderNumber,
            ["Status"] = Model.Query.Status?.ToString(),
            ["Priority"] = Model.Query.Priority?.ToString(),
            ["IsActive"] = Model.Query.IsActive?.ToString(),
            ["IncludeInactive"] = Model.Query.IncludeInactive.ToString(),
            ["PageSize"] = Model.Query.PageSize.ToString()
        }
    };

    var statusOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.Status is null },
        new() { Value = "0", Text = "Issued", Selected = Model.Query.Status == 0 },
        new() { Value = "1", Text = "Scheduled", Selected = Model.Query.Status == 1 },
        new() { Value = "2", Text = "In Progress", Selected = Model.Query.Status == 2 },
        new() { Value = "3", Text = "Completed", Selected = Model.Query.Status == 3 },
        new() { Value = "4", Text = "Canceled", Selected = Model.Query.Status == 4 },
        new() { Value = "5", Text = "Partially completed", Selected = Model.Query.Status == 5 }
    };

    var priorityOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.Priority is null },
        new() { Value = "0", Text = "Low", Selected = Model.Query.Priority == 0 },
        new() { Value = "1", Text = "Normal", Selected = Model.Query.Priority == 1 },
        new() { Value = "2", Text = "High", Selected = Model.Query.Priority == 2 },
        new() { Value = "3", Text = "Urgent", Selected = Model.Query.Priority == 3 }
    };

    var activeOptions = new List<GridSelectOption>
    {
        new() { Value = string.Empty, Text = "Any", Selected = Model.Query.IsActive is null },
        new() { Value = "true", Text = "Active", Selected = Model.Query.IsActive == true },
        new() { Value = "false", Text = "Inactive", Selected = Model.Query.IsActive == false }
    };

    var filters = new GridFilterViewModel
    {
        Action = "Index",
        Controller = "InboundOrders",
        Fields = new List<GridFilterField>
        {
            new() { Name = "OrderBy", Value = Model.Query.OrderBy, IsHidden = true },
            new() { Name = "OrderDir", Value = Model.Query.OrderDir, IsHidden = true },
            new() { Label = "Order Number", Name = "OrderNumber", Type = GridFilterType.Text, Value = Model.Query.OrderNumber, IconClass = "bi-hash" },
            new() { Label = "Warehouse", Name = "WarehouseId", Type = GridFilterType.Select, Options = Model.Warehouses.Select(w => new GridSelectOption { Value = w.Value ?? string.Empty, Text = w.Text ?? string.Empty, Selected = w.Selected }).ToList(), IconClass = "bi-building" },
            new() { Label = "Status", Name = "Status", Type = GridFilterType.Select, Options = statusOptions, IconClass = "bi-circle-half" },
            new() { Label = "Priority", Name = "Priority", Type = GridFilterType.Select, Options = priorityOptions, IconClass = "bi-flag" },
            new() { Label = "Active", Name = "IsActive", Type = GridFilterType.Select, Options = activeOptions, IconClass = "bi-toggle-on" },
            new()
            {
                Label = "Include inactive",
                Name = "IncludeInactive",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "false", Text = "No", Selected = Model.Query.IncludeInactive == false },
                    new() { Value = "true", Text = "Yes", Selected = Model.Query.IncludeInactive }
                },
                IconClass = "bi-eye"
            },
            new()
            {
                Label = "Page Size",
                Name = "PageSize",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "10", Text = "10", Selected = Model.Query.PageSize == 10 },
                    new() { Value = "25", Text = "25", Selected = Model.Query.PageSize == 25 },
                    new() { Value = "50", Text = "50", Selected = Model.Query.PageSize == 50 }
                }
            }
        },
        ShowReset = true,
        ResetUrl = Url.Action("Index", "InboundOrders")
    };

    var filterDrawer = new FilterDrawerViewModel
    {
        Id = "inboundOrderFilters",
        Title = "Inbound order filters",
        Filters = filters,
        ButtonText = "Filters",
        ButtonCssClass = "btn btn-outline-primary"
    };

    var grid = new GridBuilder<DevcraftWMS.DemoMvc.ViewModels.InboundOrders.InboundOrderListItemViewModel>()
        .WithTitle("Inbound Orders")
        .WithSubtitle($"Total: {Model.Pagination.TotalCount}")
        .WithItems(Model.Items)
        .WithPagination(Model.Pagination)
        .WithQueryOptions(queryOptions)
        .WithTableCssClass("table align-middle mb-0 grid-table")
        .WithFilters(filters)
        .AddColumn("Order", item => new HtmlString(HtmlEncoder.Default.Encode(item.OrderNumber)), "OrderNumber")
        .AddColumn("Emergency", item => item.IsEmergency
            ? new HtmlString("<span class=\"badge text-bg-danger\">Emergency</span>")
            : new HtmlString("<span class=\"text-muted\">-</span>"))
        .AddColumn("ASN", item => new HtmlString(HtmlEncoder.Default.Encode(item.AsnNumber ?? "-")), "AsnNumber")
        .AddColumn("Warehouse", item => new HtmlString(HtmlEncoder.Default.Encode(item.WarehouseName)), "WarehouseName")
        .AddColumn("Status", item => new HtmlString(item.Status switch
        {
            0 => "Issued",
            1 => "Scheduled",
            2 => "In Progress",
            3 => "Completed",
            4 => "Canceled",
            5 => "Partially completed",
            _ => $"Status {item.Status}"
        }), "Status")
        .AddColumn("Priority", item => new HtmlString(item.Priority switch
        {
            0 => "Low",
            1 => "Normal",
            2 => "High",
            3 => "Urgent",
            _ => $"Priority {item.Priority}"
        }), "Priority")
        .AddColumn("Expected", item => new HtmlString(item.ExpectedArrivalDate?.ToString("yyyy-MM-dd") ?? "-"), "ExpectedArrivalDate")
        .AddColumn("Created", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")), "CreatedAtUtc")
        .AddAction(
            "Start Receipt",
            item => item.Status is 3 or 4 or 5 ? null : Url.Action("StartReceipt", "InboundOrders", new { id = item.Id }),
            "btn btn-sm btn-outline-success",
            "bi bi-box-arrow-in-right")
        .AddAction(
            "Approve Emergency",
            item => item.IsEmergency && item.Status == 1 ? Url.Action("ApproveEmergency", "InboundOrders", new { id = item.Id }) : null,
            "btn btn-sm btn-outline-warning",
            "bi bi-check2-circle")
        .AddAction(
            "Report",
            item => Url.Action("Report", "InboundOrders", new { id = item.Id }),
            "btn btn-sm btn-outline-primary",
            "bi bi-file-earmark-text")
        .Build();
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h3 mb-1">Inbound Orders</h1>
        <div class="text-muted">Backoffice queue for OE status and priority</div>
    </div>
    <a class="btn btn-outline-secondary" href="#inboundOrdersHelp" data-bs-toggle="modal">
        <i class="bi bi-question-circle"></i> Help
    </a>
</div>

<partial name="_FilterDrawer" model="filterDrawer" />
<partial name="_Grid" model="grid" />

<div class="modal fade" id="inboundOrdersHelp" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Inbound Orders Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This queue shows inbound orders generated from approved ASNs. Use filters to prioritize execution.</p>
                <ul>
                    <li><strong>Status and Priority</strong>: focus on urgent inbound operations first.</li>
                    <li><strong>Warehouse</strong>: see orders by site.</li>
                    <li><strong>Emergency</strong>: orders created from gate check-in without an OE; approve before starting receipts.</li>
                    <li><strong>Start Receipt</strong>: open a receiving session linked to the selected inbound order.</li>
                    <li><strong>Report</strong>: review the final receiving summary and export the CSV.</li>
                </ul>
                <p>Subscreens:</p>
                <ul>
                    <li><strong>Inbound Order Details</strong> in the portal contains parameters, cancellation, and items list.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
